services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    env_file:
      - backend/.env
    depends_on:
      database:
        condition: service_healthy
    ports:
      - "3000:3000"
    command: [
      "--db-host", "database",
      "--db-port", "5432",
      "--db-name", "postgres",
      "--db-user", "postgres",
      "--db-password", "${POSTGRES_PASSWORD}",
      "--port", "3000",
      "--log-level", "info",
    ]

  database:
    image: 'docker.io/postgres:latest'
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres"]
      interval: 5s
      retries: 5
    environment:
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
    volumes:
      - pg-data:/var/lib/postgresql

  pgadmin:
    image: 'docker.io/dpage/pgadmin4:latest'
    environment:
      PGADMIN_DEFAULT_EMAIL: "${PGADMIN_DEFAULT_EMAIL}"
      PGADMIN_DEFAULT_PASSWORD: "${PGADMIN_DEFAULT_PASSWORD}"
    ports:
      - 15080:80
    volumes:
      - pgadmin-data:/var/lib/pgadmin/

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "8080:80"
    depends_on:
      - backend

volumes:
  pg-data:
  pgadmin-data:
